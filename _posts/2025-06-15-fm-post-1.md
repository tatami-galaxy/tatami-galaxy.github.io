---
title: 'Flow Matching'
date: 2025-06-15
permalink: /posts/2025-06-15-fm-post-1./
tags:
  - category1
---

Flow matching gives us a way to model complex real world distributions (target) from simpler or known distrubitions (source). One way to visualize this is in the form of fluid flow from source to target distributions in $$d$$ dimensional Euclidean space, where the fluid is essentially probability mass. We can define a time dependent velocity field in this space which characterizes the flow. Then, converting samples from the source distribution to the target distribution can be thought of as transporting probability mass to convert one density into another along the given velocity field. 

For now, let's limit ourselves to continuous distributions or densities. We can think of the flow to be transporting probability mass over time $$t$$, where $$t$$ is real and varies from $$t \rightarrow [0,1]$$. Let the random variable corresponding to the density at time $$t$$ be given by $$X_t$$. Let $$p_0$$ and $$p_1$$ be the source and target densities respectively. Therefore $$X_0 \sim p_0$$ and $$X_1 \sim p_1$$ are the corresponding random variables. Then, the goal is to convert samples $$X_0 = x_0$$ into samples $$X_1 = x_1$$. 


![Alt text](/images/flow_matching.gif)
*Animation from Federico Sarrocco's flow matching [blog](https://federicosarrocco.com/blog/flow-matching)*

Let $$u : [0,1] \times R^d \rightarrow R^d$$ be the time dependent velocity field. This gives rise to the following ODE : 

$$u_t(x) = \frac{dx}{dt}, \tag{1}$$ 

where $$x$$ is a point in $$R^d$$. Let $$\psi_t(x)$$ be a solution to (1) with initial condition $$\psi_0(x) = x$$. That is, $$\psi_t(x)$$ gives $$x$$ at time $$t$$ after being transported along the velocity field. This is termed as the flow corresponding to the velocity field $$u$$. We will see shortly when such a flow exists and whether it's unique. 

Since we are interested in transporting probability densities, we need to apply the flow $$\psi_t$$ to the random variables we've defined above, to get random variables and their densities at any time $$t$$. This gives us :

$$X_t = \psi_t(X_0), \quad t \in [0,1], \quad X_0 \sim p_0 \tag{2}$$

Let the density corresponding to $$X_t$$ be $$p_t$$ :

$$X_t \sim p_t \tag{3}$$

$$p_t$$ can be obtained from the 'pushforward' of $$\psi_t$$ on the measure associated with $$p_0$$. This is written as : $$p_t = \psi_{t\#}p_0, \tag{4}$$

<img src="/images/pushforward_eq.png" width="300" height="100" />

![Alt text](/images/pushforward_im.png)
*From the ICML 2023 Optimal Transport [tutorial](https://icml.cc/virtual/2023/tutorial/21559)*

Let the measure associated with $$p_0$$ be $$\mu$$. Then for every measureable set $$B \subseteq R^d$$ we have $$\mu = \int_Bp_0(x)dx$$. Let the pushforward measure associated with $$p_t$$ as a result of $$\psi_t$$ be $$\nu$$. This is given by :

$$\nu = \mu(\psi_t^{-1}(B)) = \int_{\psi_t^{-1}(B)}p_0(x)dx = \int_{B}p_0(\psi_t^{-1}(x))|J(\psi_t^{-1})(x)|dx,$$

where the last expression is given by the [change of variables formula](https://en.wikipedia.org/wiki/Pushforward_measure) for a pushforward measure. Therefore : 

$$\nu = p_0(\psi_t^{-1}(x))|J(\psi_t^{-1})(x)|$$




