---
title: 'Flow Matching'
date: 2025-06-15
permalink: /posts/2025-06-15-fm-post-1./

---

## Introduction

Flow matching gives us a way to model complex real world distributions (target) from simpler or known distrubitions (source). One way to visualize this is in the form of fluid flow from source to target distributions in $$d$$ dimensional Euclidean space, where the fluid is essentially probability mass. We can define a time dependent velocity field in this space which characterizes the flow. Then, converting samples from the source distribution to the target distribution can be thought of as transporting probability mass to convert one density into another along the given velocity field. 

For now, let's limit ourselves to continuous distributions or densities. We can think of the flow to be transporting probability mass over time $$t$$, where $$t$$ is real and varies from $$t \rightarrow [0,1]$$. Let the random variable corresponding to the density at time $$t$$ be given by $$X_t$$. Let $$p_0$$ and $$p_1$$ be the source and target densities respectively. Therefore $$X_0 \sim p_0$$ and $$X_1 \sim p_1$$ are the corresponding random variables. Then, the goal is to convert samples $$X_0 = x_0$$ into samples $$X_1 = x_1$$. 


![Alt text](/images/flow_matching.gif)
*Animation from Federico Sarrocco's flow matching [blog](https://federicosarrocco.com/blog/flow-matching)*

## Velocity Field and Flow

Let $$u : [0,1] \times R^d \rightarrow R^d$$ be the time dependent velocity field. This gives rise to the following ODE : 

$$\frac{dx}{dt} = u_t(x), \tag{1}$$ 

where $$x$$ is a point in $$R^d$$. Let $$\psi_t(x)$$ be a solution to (1) with initial condition $$\psi_0(x) = x$$. That is, $$\psi_t(x)$$ gives $$x$$ at time $$t$$ after being transported along the velocity field. This is termed as the flow corresponding to the velocity field $$u$$. We will see shortly when such a flow exists and whether it's unique. 

Since we are interested in transporting probability densities, we need to apply the flow $$\psi_t$$ to the random variables we've defined above, to get random variables and their densities at any time $$t$$. This gives us :

$$X_t = \psi_t(X_0), \quad t \in [0,1], \quad X_0 \sim p_0 \tag{2}$$

Let the density corresponding to $$X_t$$ be $$p_t$$ :

$$X_t \sim p_t \tag{3}$$

Here we can enforce a reasonable constraint, which is intuitively a mass conservation constraint. Let the measure associated with $$p_0$$ be $$\mu$$ and measure associated with $$p_t$$ as a result of $$\psi_t$$ be $$\nu$$. The constraint is simply that the probability mass associated with any set $$B$$ under the new meausure $$\nu$$ must be the same as that of the set $$\psi_t^{-1}B$$ under the old measure $$\mu$$. This is called the *pushforward* constraint and is written as : 

$$p_t = \psi_{t\#}p_0 \tag{4}$$

<img src='/images/pushforward_im.png' alt='missing' width="600" height="400"/>
<img src='/images/pushforward_eq.png' alt='missing' width="300" height="100"/>

*Image from the ICML 2023 Optimal Transport [tutorial](https://icml.cc/virtual/2023/tutorial/21559)*

$$\nu$$ is given by :

$$\nu = \mu(\psi_t^{-1}(B)) = \int_{\psi_t^{-1}(B)}p_0(x)dx = \int_{B}p_0(\psi_t^{-1}(x))|J(\psi_t^{-1})(x)|dx, \tag{5}$$

where the last expression is given by the [change of variable formula](https://en.wikipedia.org/wiki/Pushforward_measure) for a pushforward measure. Therefore : 

$$\nu = p_0(\psi_t^{-1}(x))|J(\psi_t^{-1})(x)|, \tag{6}$$

where $$J$$ is the Jacobian. This means that in order for us to compute (4), $$\psi_t$$ has to be invertible, and the Jacobian of its inverse must exist. This can be enforced in a principled way in terms of a *diffeomorphism*. 

Let $$C^r(R^m, R^n)$$ denote the collection of functions $$f : R^m \rightarrow R^n$$ with continuous partial derivates of order $$r$$. Then, $$C^r$$ diffeomorphism is a class of invertible functions with $$\psi \in C^r(R^d, R^d)$$ and $$\psi^{-1} \in C^r(R^d, R^d)$$. 

We can constrain flows and velocity fields to be $$C^r([0,1] \times R^d, R^d)$$ diffeomorphisms. 

This constraint also allows us to comment on the existence and uniqueness of solutions $$\psi_t(x)$$ to equation (1). From [Lipman et al.](https://arxiv.org/abs/2412.06264) : 

**Theorem 1 :** *(Flow local existence and uniqueness). If $$u$$ is $$C^r([0,1] \times R^d, R^d), r \geq 1,$$ and locally Lipschitz in $$x$$, then ODE (1) has a unique solution which is a $$C^r(\Omega, R^d)$$ diffeomorphism $$\psi_t(x),$$ defined over an open set $$\Omega$$ which is a super-set of $$\{0\} \times R^d$$.*

A function $$f : R^d \rightarrow R^d$$ is Lipschitz continuous if there exists a postive real constant $$K$$ such that for all real $$x_1$$ and $$x_2$$ : 

$$|f(x_1) - f(x_2)| \leq K|x_1 - x_2|$$

A function is locally Lipschitz continuous if for every $$x$$ in $$R^d$$ there exists a neighborhood $$U$$ of $$x$$ such that $$f$$ restricted to $$U$$ is Lipschitz continuous. In general, Lipschitz continuity is a strong form of uniform continuity for functions which limits the function in terms of how fast it can change. *Theorem 1* guarantees only the local existence and uniqueness of a $$C^r$$ flow moving each point $$x \in R^d$$ by $$\psi_t(x)$$ in a limited time frame $$t \in [0, t_x)$$.

*TODO* : what if we allow non-unique solutions? [Picard–Lindelöf theorem](https://en.wikipedia.org/wiki/Picard%E2%80%93Lindel%C3%B6f_theorem), [Peano theorem](https://en.wikipedia.org/wiki/Peano_existence_theorem), [Carathéodory's existence theorem](https://en.wikipedia.org/wiki/Carath%C3%A9odory%27s_existence_theorem)

To guarantee a solution until $$t = 1$$ for all $$x \in R^d$$, we must make additional assumptions beyond local Lipschitzness. This is the integrability condition : 

$$\int_{0}^{1}\int\||u_t(x)||p_t(x)dxdt < 0 \tag{7}$$

The mass conservation or pushforward constraint (4) can also be stated in terms of the [Continuity Equation](https://link.springer.com/book/10.1007/978-3-540-71050-9) : 

$$\frac{d}{dt}p_t(x) + div(p_t(x)u_t(x)) = 0, \tag{8}$$

where $$u_t$$ is the time varying velocity field as before, $$x = [x^1, ..., x^d]$$ and $$div$$ is the divergence operator, given by $$div = \sum_{i=1}^{d}\frac{\partial}{\partial x^i}$$. It essentially says that if $$u$$ is *smooth*, given some domain $$D$$, accumulating divergences of $$u$$ inside $$D$$ equals the *flux* leaving $$D$$ by orthogonally crossing its boundary $$\partial D$$ ([Lipman et al.](https://arxiv.org/abs/2412.06264)). The Continuity Equation (8) gives us a way to compute $$p_t$$ from $$u_t$$, whereas the pushforward constrain (4) allows us to compute $$p_t$$ from $$\psi_t$$. 






